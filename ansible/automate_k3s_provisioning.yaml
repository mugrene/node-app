---
- hosts: localhost
  vars:
    master_node: "k3s-master"
    worker_nodes:
      - "k3s-worker-1"
      - "k3s-worker-2"
      - "k3s-worker-3"

  tasks:
    - name: Install MicroK8s on all existing nodes
      loop: "{{ [master_node] + worker_nodes }}"
      shell: |
        multipass exec {{ item }} -- sudo snap install microk8s --classic
        multipass exec {{ item }} -- sudo usermod -a -G microk8s ubuntu
        multipass exec {{ item }} -- sudo microk8s status --wait-ready

    - name: Get the master node IP address
      shell: multipass info {{ master_node }} | grep IPv4 | awk '{print $2}'
      register: master_ip
      changed_when: false

    - name: Generate join tokens and join workers
      # MicroK8s requires a unique token for each node join
      loop: "{{ worker_nodes }}"
      shell: |
        # Generate token on master
        TOKEN_LINE=$(multipass exec {{ master_node }} -- microk8s add-node | grep 'microk8s join' | head -n 1)
        # Execute join on worker
        multipass exec {{ item }} -- $TOKEN_LINE
      register: join_results

    - name: Enable essential MicroK8s addons on master
      shell: |
        multipass exec {{ master_node }} -- microk8s enable dns storage

    - name: Retrieve Kubeconfig from master
      shell: multipass exec {{ master_node }} -- microk8s config
      register: kubeconfig_raw

    - name: Ensure local .kube directory exists
      file:
        path: ~/.kube
        state: directory
        mode: '0700'

    - name: Write and configure local Kubeconfig
      copy:
        content: "{{ kubeconfig_raw.stdout }}"
        dest: ~/.kube/config
        mode: '0600'

    - name: Update Kubeconfig to use master's external IP
      lineinfile:
        path: ~/.kube/config
        regexp: 'server: https://127.0.0.1:16443'
        line: "    server: https://{{ master_ip.stdout.strip() }}:16443"

    - name: Verify cluster status
      shell: multipass exec {{ master_node }} -- microk8s kubectl get nodes
      register: final_nodes

    - name: Display MicroK8s cluster nodes
      debug:
        msg: "{{ final_nodes.stdout_lines }}"